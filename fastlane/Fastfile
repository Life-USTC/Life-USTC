platform :ios do
  desc "Build IPA for App Store distribution"
  lane :build_ipa do
    setup_ci if is_ci
    build_number = Time.now.strftime("%Y.%m.%d.%H%M%S")
    increment_build_number(build_number: build_number)
    match(type: "development", readonly: true)
    match(type: "appstore", readonly: true)
    gym(
      scheme: "Life-USTC",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "dev.tiankaima.Life-USTC": "match AppStore dev.tiankaima.Life-USTC",
          "dev.tiankaima.Life-USTC.Widget": "match AppStore dev.tiankaima.Life-USTC.Widget",
        },
      },
    )
  end

  desc "Upload existing IPA to TestFlight"
  lane :testflight_upload do
    setup_ci if is_ci
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY"],
      is_key_content_base64: true,
      in_house: false,
    )
    pilot(
      skip_waiting_for_build_processing: true,
      ipa: Dir["*.ipa"].first
    )
  end

  desc "Wait for specific TestFlight build to finish processing"
  lane :testflight_wait_for_processing do |options|
    build_number = options[:build_number]
    UI.user_error!("No build_number provided in options!") unless build_number

    setup_ci if is_ci
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY"],
      is_key_content_base64: true,
      in_house: false,
    )

    app = Spaceship::ConnectAPI::App.find("dev.tiankaima.Life-USTC")

    UI.message("Waiting for build (#{build_number}) to finish processing...")
    loop do
      builds = app.get_builds(filter: { version: build_number })
      if builds.empty?
        UI.message("Build not found yet, waiting...")
        sleep(30)
        next
      end

      build = builds.first
      processing_state = build.processing_state
      UI.message("Current processing state: #{processing_state}")

      if build.processed?
        UI.success("Build (#{build_number}) has finished processing!")
        break
      end
      UI.message("Still processing, checking again in 30 seconds...")
      sleep(30)
    end
  end

  desc "Add to TestFlight Group"
  lane :testflight_add_to_group do |options|
    setup_ci if is_ci
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY"],
      is_key_content_base64: true,
      in_house: false
    )

    pilot(
      app_platform: "ios",
      app_identifier: "dev.tiankaima.Life-USTC",
      distribute_only: true,
      distribute_external: true,
      beta_app_description: "Automatically uploaded via Fastlane",
      groups: ["Beta"],
    )
  end
end
